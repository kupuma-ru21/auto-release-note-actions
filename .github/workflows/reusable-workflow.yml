# https://docs.github.com/ja/actions/using-workflows/reusing-workflows#creating-a-reusable-workflow
name: Create release tag and release note.

on:
  workflow_call:
    secrets:
      token:
        required: true

jobs:
  create-release-tag:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # å‰å›ã®ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã‚’å–å¾—ã™ã‚‹
      - name: Get previous tag
        id: pre_tag
        run: |
          echo "pre_tag=$(curl -H 'Accept: application/vnd.github.v3+json' -H 'Authorization: token ${{ secrets.token }}' https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)" >> $GITHUB_OUTPUT

      # ã‚¿ã‚°ã‚’ç”Ÿæˆã™ã‚‹ ã€Œ{YYYY.MM.DD}-{å½“æ—¥ãƒªãƒªãƒ¼ã‚¹å›æ•°}ã€
      - name: Generate release tag
        id: release_tag
        run: |
          today=$(date +'%Y.%m.%d')
          pre_release_date=$(echo ${{ steps.pre_tag.outputs.pre_tag }} | awk -F'-' '{print $1}')
          pre_release_count=$(echo ${{ steps.pre_tag.outputs.pre_tag }} | awk -F'-' '{print $2}')
          if [[ ! $pre_release_date = $today ]]; then
            echo "init count"
            pre_release_count=0
          fi
          echo "release_tag=$today-$(($pre_release_count + 1))" >> $GITHUB_OUTPUT

      # å‰å›ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ã®å·®åˆ†ã‚’ã‚‚ã¨ã«ã€ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®æœ¬æ–‡ã‚’ç”Ÿæˆã™ã‚‹(https://docs.github.com/en/rest/releases/releases?apiVersion=2022-11-28#generate-release-notes-content-for-a-release)
      # 1. curlã‚’å©ã„ã¦ã€ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®æœ¬æ–‡ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®jsonã‚’å–å¾—

      # 2. ã€Œjq .bodyã€ã§jsonã®bodyã‚’å–ã‚Šå‡ºã™

      # 3. sedã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’è¡Œã†
      # ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã®å…·ä½“çš„ãªæ„å›³ã¯ä»¥ä¸‹ã€‚
      # sedå‡¦ç†ãŒãªã„å ´åˆã€bodyã®å€¤ã«ã¯ã€Œ"<!-- Release notes generated using configuration in .github/release.yml at main -->\\n\\n## What's Changed\\n### Other Changes ğŸ› \\n* Revert \"chore: remove json\" by @kupuma-ru21 in https://github.com/kupuma-ru21/auto-release-note/pull/2\\n\\n\\n**Full Changelog**: https://github.com/kupuma-ru21/auto-release-note/compare/2023.07.12-1...2023.07.12-2"ã€ã®ã‚ˆã†ãªæ–‡è¨€ãŒå…¥ã£ã¦ãã‚‹
      # bodyã®å€¤ã®ä¸­ã«ã€ŒWhat'sã€ã¨ã„ã†æ–‡è¨€ãŒã‚ã‚‹ã€‚ã€ŒWhat'sã€å†…ã®ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«èµ·å› ã—ã€å¾Œç¶šã®ã€ŒCreate Releaseã€ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã€syntax errorãŒç™ºç”Ÿã™ã‚‹ã€‚
      # ã€ŒCreate Releaseã€ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã€syntax errorãŒç™ºç”Ÿã™ã‚‹ç†ç”±ã¯ä»¥ä¸‹ã€‚
      # ã€ŒCreate Releaseã€ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã€-dã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã€é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã£ã¦ã‚‹(ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã£ã¦ã‚‹ç†ç”±ã¯ã€ã€ŒCreate Releaseã€ã®ã‚³ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰)
      # é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã†ã“ã¨ã«ã‚ˆã‚Šã€ã€ŒWhat'sã€å†…ã®ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒã€çµ‚äº†ã®ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦èªè­˜ã•ã‚Œã¦ã—ã¾ã†ã€‚
      # ex: -d '{..., "body": "... What's ..."}'
      # '(<= é–‹å§‹ã®ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³){..., "body": "... What'(<= ã“ã“ãŒçµ‚äº†ã®ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹)s ..."}'(<= æœ¬æ¥ã¯æœ«å°¾ã®ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã®ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ã¹ã)
      # ãªã®ã§ã€sedã‚’ä½¿ç”¨ã—ã€ŒWhat'sã€å†…ã«ã‚ã‚‹ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’è¡Œã£ã¦ã‚‹ã€‚
      # ã€Œã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’è¡Œã†ã€ã«é–¢ã—ã¦ã¯å³è¨˜ã‚’å‚ç…§ > https://qiita.com/sumomo_99/items/5fb9c054c542456a6cdc

      # 4. awkã‚’ä½¿ç”¨ã—ã€bodyã®å€¤ã‚’å›²ã£ã¦ã‚‹ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
      # bodyã®å€¤ã¯ã€å¾Œç¶šã®ã€ŒCreate Releaseã€ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã€ã€Œsteps.release_note.outputs.release_noteã€ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã‚‹ > "body": "${{ steps.release_note.outputs.release_note }}"
      # awkã‚’ä½¿ç”¨ã—ãªã„å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã€syntax errorãŒç™ºç”Ÿã™ã‚‹
      # -d `{..., "body": ""bodyã®å€¤""}`
      # "(<= é–‹å§‹ã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³)"(<= æœ¬æ¥ã¯æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã¹ãã ãŒã€çµ‚äº†ã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã—ã¾ã†)bodyã®å€¤""(<= çµ‚äº†ã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã¹ãã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³)
      # ãªã®ã§ã€syntax errorã‚’å›é¿ã™ã‚‹ãŸã‚ã€awkã‚’ä½¿ç”¨ã—ã¦ã‚‹

      - name: Generate release note
        id: release_note
        run: |
          echo "release_note=$(curl -X POST -H 'Accept: application/vnd.github.v3+json' -H 'Authorization: token ${{ secrets.token }}' https://api.github.com/repos/${{ github.repository }}/releases/generate-notes -d '{"tag_name":"${{ steps.release_tag.outputs.release_tag }}", "previous_tag_name":"${{ steps.pre_tag.outputs.pre_tag }}"}' | jq .body | sed "s/'/\'\\\'\'/g" | awk '{print substr($0, 2, length($0)-2)}')" >> $GITHUB_OUTPUT

      # ã‚¿ã‚°ã‚’åˆ‡ã‚Šã€ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹(https://docs.github.com/en/rest/releases/releases?apiVersion=2022-11-28#create-a-release)
      # curlã‚’å©ãéš›ã«ã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ãªãã€ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã£ã¦ã‚‹ç†ç”± > ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã†ã¨ã€PRã‚¿ã‚¤ãƒˆãƒ«ã«ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå…¥ã£ã¦ã‚‹å ´åˆ(revertPRãªã©)ã€PRã‚¿ã‚¤ãƒˆãƒ«å†…ã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã‚ˆã†ã¨ã™ã‚‹éš›ã«ã€è‰²ã€…ã¨ä¸æ•´åˆãŒç”Ÿã˜ã€syntax errorã«ãªã£ã¦ã—ã¾ã†ã€‚
      - name: Create Release
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.token }}" \
            -d '{ "tag_name": "${{ steps.release_tag.outputs.release_tag }}", "name": "${{ steps.release_tag.outputs.release_tag }}", "body": "${{ steps.release_note.outputs.release_note }}"}' \
            https://api.github.com/repos/${{ github.repository }}/releases
